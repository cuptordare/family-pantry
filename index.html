<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Family Pantry</title>
    
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="manifest.json">

    <style>
body {
    --app-bg-color: #fff;
    --app-text-color: #333;

    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    font-size: 16px;
    margin: 0;
    padding: 0;
    background: var(--app-bg-color);
    color: var(--app-text-color);
    min-height: 100vh;
}

#bg {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 100svh;
    /* behind content */
    z-index: -1;
    transition: opacity 0.2;
}

/* Mobile devices in portrait orientation */
@media (max-width: 768px) and (orientation: portrait) {}

#app {
    position: relative;
    z-index: 1;
    max-width: 768px;
    margin: 0 auto;
    transition: opacity 0.3s ease;
}

.fade-out {
    opacity: 0;
}

.fade-in {
    opacity: 1;
}

svg {
    display: block;
    pointer-events: none;
    fill: currentColor;
}

a {
    color: #6200ee;
}

/* ---------- loading */

/* Base: hidden by default */
[data-loading]::before,
[data-loading]::after {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
}

/* Transparent dark overlay */
[data-loading]::before {
    background: rgba(0, 0, 0, 0.35);
    pointer-events: auto;
}

/* Spinner */
[data-loading]::after {
    width: 48px;
    height: 48px;
    border: 4px solid rgba(255, 255, 255, 0.35);
    border-top-color: #fff;
    border-radius: 50%;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation: spin 0.9s linear infinite;
}

/* Spinner animation */
@keyframes spin {
    to {
        transform: translate(-50%, -50%) rotate(360deg);
    }
}

/* ---------- title bar */

.view-title-bar {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding: 5px;
}

.user-bubble {
    background-color: #6200ee;
    color: #fff;
    border-radius: 8px;
    text-transform: capitalize;
    padding: 2px 5px;
    font-size: 24px;
}

.view-title {
    margin: 0 auto 0 10px;
    font-size: 24px;
}

.view-menu-item {
    display: block;
    color: inherit;
    padding: 4px 4px;
    border-radius: 8px;
    margin-left: 5px;
    transition: all 0.3s;
}

.view-menu-item[data-active] {
    background-color: #eee;
}

/* ---------- nav bottom */

.bottom-menu {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100vw;
    background: var(--app-bg-color);
    display: flex;
    border-top: 1px solid #eee;
    box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.06);
    z-index: 100;
    height: 64px;

    .menu-tab {
        flex: 1;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 15px;
    }

    .menu-tab--active {
        background-color: #6200ee;
        color: #fff;
    }
}

/* ---------- modal */

.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.4);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal.show {
    display: flex;
}

.modal-shell {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease, opacity 0.3s ease;
    opacity: 0;
    /* start hidden, off screen */

    .modal-content {
        max-height: 80Vh;
        overflow: auto;
    }
}

/* bottom slide */
.modal-shell.bottom {
    bottom: 0;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    transform: translate(-50%, 100%);

    .modal-content {
        padding: 20px 20px 40px;
    }
}

.modal-shell.bottom.show {
    transform: translate(-50%, 0);
    opacity: 1;
}

/* top slide */
.modal-shell.top {
    top: 0;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    transform: translate(-50%, -100%);

    .modal-content {
        padding: 40px 20px 20px;
    }
}

.modal-shell.top.show {
    transform: translate(-50%, 0);
    opacity: 1;
}

/* ---------- wants */

.wants-title {
    font-weight: 500;
    background-color: #f8f8f8;
    padding: 5px;
    border-top: solid 1px #eee;
    display: flex;
    align-items: center;
}

.wants-title svg {
    margin-right: 5px;
}

.wants-card {
    display: flex;
    padding: 5px;
    border-top: solid 1px #eee;

    .wants-card__body {
        flex: 1 1 auto;
    }

    .wants-card__list {
        color: #999;
        font-size: 14px;
    }

    .wants-card__actions {
        flex: none;
    }

    .wants-user {
        color: var(--app-text-color);
    }
}

.wants-card:last-child {
    border-bottom: solid 1px #eee;
}

/* ---------- selection modal */

.selection-modal {
    input[type="search"] {
        width: 100%;
        box-sizing: border-box;
        border: solid 2px #ccc;
        border-radius: 3px;
        padding: 5px 8px;
        font-size: 18px;
    }

    .select-option+.select-option {
        margin-top: 10px;
    }

    .select-option {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
        width: fit-content;

        input[type="checkbox"] {
            display: none;
        }

        .select-option-checkmark {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            border: 2px solid #ccc;
            margin-right: 12px;
            transition: border-color 0.2s, background 0.2s;
            background: #fff;
            position: relative;
        }

        input:checked+.select-option-checkmark {
            background: #6200ee;
            border-color: #6200ee;
        }

        .select-option-checkmark::after {
            content: "";
            position: absolute;
            display: none;
        }

        input:checked+.select-option-checkmark::after {
            display: block;
            left: 7px;
            top: 2px;
            width: 6px;
            height: 12px;
            border: solid #fff;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        .select-option-content {
            flex: 1;
            transition: color 0.2s;
        }

        input:checked~.select-option-content {
            color: #6200ee;
        }
    }
}
</style>
</head>

<body>
    <div id="bg"></div>
    <main id="app"></main>

    
<script>
(function(){
    // Base64 decode to bytes string
    const binaryString = atob('Ly8gR01haWw6Y3VwdG9kYXJlID4gQXBwU2NyaXB0cyA+IGh0dHBzOi8vc2NyaXB0Lmdvb2dsZS5jb20vaG9tZQ0KDQp3aW5kb3cuYXBwU2VjcmV0cyA9IHsNCiAgICBBUFBfREFUQV9VUkw6ICJodHRwczovL3NjcmlwdC5nb29nbGUuY29tL21hY3Jvcy9zL0FLZnljYnlvSy1SSTRUNC1DTURxNS1nVGFaX3J2M3oxOV9OQmh4NmtnT2ZRZFdGUFVUaHk1Z1FMQ1dXemtpVXl5ZTRPajRDaFFBL2V4ZWMiLA0KICAgIEFQUF9EQVRBX1NFQ1JFVDogIjQ5MDBiMTlmLWQ1NDYtNDBjMy04YjYzLTkzNjIwYTVhMzYwOSIsDQp9Ow==');
    // Convert binary string to UTF-8 decoded string
    const utf8decoder = new TextDecoder();
    const bytes = Uint8Array.from(binaryString, c => c.charCodeAt(0));
    const decoded = utf8decoder.decode(bytes);

    eval(decoded);
})();
</script>
    <script>
const APP_DATA_URL = window.appSecrets.APP_DATA_URL
const APP_DATA_SECRET = window.appSecrets.APP_DATA_SECRET;

// Google Sheets cell limit:
// 50,000 characters per cell, 10 million total cells

// Google Apps Script Web Apps limits: (Free Tier Limit)
// Max execution time per request:	~30 seconds
// Daily total execution time:	90 minutes / day
// URLFetch calls:	20,000 / day
// Spreadsheet reads:	20,000 / day
// Spreadsheet writes:	20,000 / day
// Concurrent executions:	Limited (unofficial, but ~30â€“50)

const LOCAL_STORAGE_ONLY = false; // for testing

window.AppData = {
    clearCache,
    getUserData,
    updateUserData,
    getAllUserCodes,
    getKnownBreakfastOptions,
    getKnownLunchOptions,
    getKnownDinnerOptions,
    getKnownGroceryOptions,
    getKnownOtherOptions,
};

async function getItem(id) {
    const res = await fetch(APP_DATA_URL, {
        method: "POST",
        body: JSON.stringify({
            secret: APP_DATA_SECRET,
            action: "get",
            id
        })
    });
    return res.json();
}

async function setItem(id, obj) {
    const res = await fetch(APP_DATA_URL, {
        method: "POST",
        body: JSON.stringify({
            secret: APP_DATA_SECRET,
            action: "set",
            id,
            data: obj
        })
    });
    return res.json();
}

async function deleteItem(id) {
    const res = await fetch(APP_DATA_URL, {
        method: "POST",
        body: JSON.stringify({
            secret: APP_DATA_SECRET,
            action: "delete",
            id
        })
    });
    return res.json();
}

async function getAll() {
    const res = await fetch(APP_DATA_URL, {
        method: "POST",
        body: JSON.stringify({
            secret: APP_DATA_SECRET,
            action: "getAll"
        })
    });
    return res.json();
}

function getEmptyUserData() {
    return {
        dinnerWants: [],
        dinnerMaybes: [],
        dinnerNotWants: [],
        lunchWants: [],
        lunchMaybes: [],
        lunchNotWants: [],
        breakfastWants: [],
        breakfastMaybes: [],
        breakfastNotWants: [],
        groceryWants: [],
        otherWants: [],
    };
}

const STORAGE_KEY_FORMAT = `familyPantry:user:{code}:v1`;

function clearCache() {
    getAllUserCodes().forEach(code => {
        const id = STORAGE_KEY_FORMAT.replace('{code}', code);
        localStorage.removeItem(id);
    });
}

async function getUserData(code, skipCache = false) {
    if (!getAllUserCodes().includes(code))
        throw new Error(`Invalid user code: ${code ?? ''}`);

    const id = STORAGE_KEY_FORMAT.replace('{code}', code);
    const data = getEmptyUserData();

    if (!skipCache) {
        try {
            const jsonFromCache = localStorage.getItem(id);
            const dataFromCache = jsonFromCache ? JSON.parse(jsonFromCache) : null;
            if (dataFromCache) {
                Object.assign(data, dataFromCache);
                return data;
            }
        }
        catch (error) {
            console.error(error);
        }
    }

    if (!LOCAL_STORAGE_ONLY) {
        try {
            const dataFromStorage = await getItem(id);
            if (dataFromStorage) {
                Object.assign(data, dataFromStorage);
            }
        }
        catch (error) {
            console.error(error);
            return 'FAILED-TO-LOAD-USER-DATA';
        }
    }

    localStorage.setItem(id, JSON.stringify(data));

    return data;
}

async function updateUserData(code, dataWithChanges) {
    if (!getAllUserCodes().includes(code))
        throw new Error(`Invalid user code: ${code ?? ''}`);

    const id = STORAGE_KEY_FORMAT.replace('{code}', code);
    const data = getEmptyUserData();

    if (dataWithChanges) {
        Object.assign(data, dataWithChanges);
    }

    localStorage.setItem(id, JSON.stringify(data));

    if (!LOCAL_STORAGE_ONLY) {
        await setItem(id, data);
    }
}

function getAllUserCodes() {
    return [
        'SW1984',
        'CW1985',
        'CW2011',
        'KW2015',
    ];
}

function getKnownDinnerOptions() {
    return [
        'Baked Chicken',
        'Beef Au Jus Biscuit Dip',
        'Beef Tacos',
        'Bowtie Cheesy Pasta',
        'Breakfast for Dinner',
        'Bourbon Chicken',
        'Biscuit Hamburger Casserole',
        'Chicken and Dumplings',
        'Chicken Green Bean Bake',
        'Chicken Noodle Soup',
        'Chicken Primavera',
        'Chicken Pot Pie',
        'Chicken Tetrazzini',
        'Chicken Tacos',
        'Cajun Jambalaya',
        'Enchilada Pizza',
        'Enchiladas',
        'Fish',
        'Fish Sticks',
        'French Dip Sandwich',
        'Grilled Cheese Sandwiches',
        'Hamburger Helper',
        'Hamburgers',
        'Hot Dogs',
        'Jerk Chicken',
        'Lasagna',
        'Macaroni and Cheese',
        'Meatballs',
        'Meatloaf',
        'Pigs in a Blanket',
        'Pizza',
        'Pork Chops (Soy Sauce)',
        'Pork Chops (Rice and Beans)',
        'Pork Tenderloin',
        'Pot Roast',
        'Chicken Quesadillas',
        'Ribs',
        'Sloppy Joes',
        'Spaghetti',
        'Spaghetti (Baked)',
        'Steak',
        'Steak Quesadillas',
        'Steak Stir Fry',
        'Sushi',
        'Swedish Meatballs',
        'Taco Lasagna',
        'Thai Peanut Chicken and Noodles',
        'Turkey',
        'Whole Roast Chicken',
    ];
}

function getKnownLunchOptions() {
    return [
        'Beef Sandwich',
        'BLT Sandwich',
        'French Dip Sandwich',
        'Grilled Cheese Sandwich',
        'Grilled Chicken Sandwich',
        'Ham Sandwich',
        'Italian Sub',
        'Philly Cheesesteak',
        'Pulled Pork Sandwich',
        'Roast Beef Sandwich',
        'Salisbury Steak',
        'Turkey Sandwich',
    ];
}

function getKnownBreakfastOptions() {
    return [
        'Bacon',
        'Eggs',
        'Muffins (Banana Nut)',
        'Muffins (Blueberry)',
        'Muffins (Chocolate Chip)',
        'Pancates',
        'Sausage',
        'Waffles',
    ];
}

function getKnownGroceryOptions() {
    return [
        'Advil',
        'Aluminum Foil',
        'Apples',
        'Bananas',
        'Bathroom Wipes',
        'Body Wash',
        'Bread',
        'Butter',
        'Catchup',
        'Cheese (Sliced)',
        'Coke',
        'Conditioner',
        'Cooking Oil',
        'Coffee',
        'Cranberry Juice',
        'Deodorant',
        'Diet Coke',
        'Dish Detergent',
        'Dish Jet Dry',
        'Dish Soap',
        'Eggs',
        'Face Wash',
        'Floss',
        'Ginger Ale',
        'Grapes',
        'Gum',
        'Hand Soap',
        'Hot Sauce',
        'Laundry Detergent',
        'Milk',
        'Mouth Wash',
        'Paper Plates',
        'Paper Towels',
        'Peanut Butter Crackers',
        'Plastic Wrap',
        'Popcorn',
        'Mayo',
        'Mustard',
        'Ranch',
        'Salt',
        'Sargento Balanced Breaks',
        'Shampoo',
        'Sugar',
        'Toilet Paper',
        'Toothpaste',
        'Trash Bags (Garage)',
        'Trash Bags (House)',
        'Vitamin Water',
        'Worcestershire Sauce',
        'Ziplock Bags',
    ];
}

function getKnownOtherOptions() {
    return [
        'Filters (House)',
        'Socks',
        'Tequila',
        'Underwear',
        'Vodka',
        'Whiskey',
    ];
}
</script>
    <script>
const LAST_ACTIVE_TAB_KEY = 'familyPantry:user:{code}:tab:v1';

window.AppUtils = {

    sortItems(items) {
        return items.sort((item1, item2) => {
            return item1.toLowerCase().localeCompare(item2.toLowerCase());
        });
    },

    buildTitleBarElement(code, currentView) {
        const el = document.createElement('div');
        el.classList.add('view-title-bar');
        el.innerHTML = `
        <div class="user-bubble">
            ${code.substring(0, 2).toLowerCase()}
        </div>
        <div class="view-title">
            Family Pantry
        </div>
        <a href="#" class="view-menu-item" data-navigate-to="user">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="24px" width="24px"><path d="M234-276q51-39 114-61.5T480-360q69 0 132 22.5T726-276q35-41 54.5-93T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 59 19.5 111t54.5 93Zm246-164q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q53 0 100-15.5t86-44.5q-39-29-86-44.5T480-280q-53 0-100 15.5T294-220q39 29 86 44.5T480-160Zm0-360q26 0 43-17t17-43q0-26-17-43t-43-17q-26 0-43 17t-17 43q0 26 17 43t43 17Zm0-60Zm0 360Z"/></svg>
        </a>
        <a href="#" class="view-menu-item" data-navigate-to="store">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="24px" width="24px"><path d="M160-720v-80h640v80H160Zm0 560v-240h-40v-80l40-200h640l40 200v80h-40v240h-80v-240H560v240H160Zm80-80h240v-160H240v160Zm-38-240h556-556Zm0 0h556l-24-120H226l-24 120Z"/></svg>
        </a>`;

        el.querySelector(`[data-navigate-to="${currentView}"]`).setAttribute('data-active', '');

        el.addEventListener('click', (event) => {
            if (event.target.classList.contains('user-bubble')) {
                // clear everything and reload
                localStorage.clear();
                document.location.reload();
            }
            else if (event.target.matches('[data-active]')) {
                window.AppData.clearCache();
                // event will fall through to the router which will reload
            }
        });

        return el;
    },

    getLastActiveTab(code) {
        const key = LAST_ACTIVE_TAB_KEY.replace('{code}', code);
        return localStorage.getItem(key) ?? 'meals';
    },

    setLastActiveTab(code, tab) {
        const key = LAST_ACTIVE_TAB_KEY.replace('{code}', code);
        return localStorage.setItem(key, tab);
    },

    buildBottomMenuElement(code, activeTab, handleTabChange) {
        const el = document.createElement('nav');
        el.classList.add('bottom-menu');
        el.innerHTML = `
        <div class="menu-tab" data-tab="meals">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M320-200h60v-270q26-8 43-28.5t17-49.5v-152q0-8-6-14t-14-6q-8 0-14 6t-6 14v100h-30v-100q0-8-6-14t-14-6q-8 0-14 6t-6 14v100h-30v-100q0-8-6-14t-14-6q-8 0-14 6t-6 14v152q0 29 17 49.5t43 28.5v270Zm240 0h60v-254q33-16 51.5-51t18.5-82q0-57-28.5-95T590-720q-43 0-71.5 38T490-587q0 47 18.5 82t51.5 51v254ZM160-80q-33 0-56.5-23.5T80-160v-640q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v640q0 33-23.5 56.5T800-80H160Zm0-80h640v-640H160v640Zm0 0v-640 640Z"/></svg>
            </span>
            <span class="menu-label">Meals</span>
        </div>
        <div class="menu-tab" data-tab="supplies">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M280-600v-80h560v80H280Zm0 160v-80h560v80H280Zm0 160v-80h560v80H280ZM160-600q-17 0-28.5-11.5T120-640q0-17 11.5-28.5T160-680q17 0 28.5 11.5T200-640q0 17-11.5 28.5T160-600Zm0 160q-17 0-28.5-11.5T120-480q0-17 11.5-28.5T160-520q17 0 28.5 11.5T200-480q0 17-11.5 28.5T160-440Zm0 160q-17 0-28.5-11.5T120-320q0-17 11.5-28.5T160-360q17 0 28.5 11.5T200-320q0 17-11.5 28.5T160-280Z"/></svg>
            </span>
            <span class="menu-label">Supplies</span>
        </div>`;

        el.querySelector(`[data-tab="${activeTab}"]`).classList.add('menu-tab--active');

        el.addEventListener('click', (event) => {
            const newTab = event.target.closest('[data-tab]').getAttribute('data-tab');
            window.AppUtils.setLastActiveTab(code, newTab);
            handleTabChange(newTab);
        });

        return el;
    },

    buildSelectionModalElement() {
        const el = document.createElement('div');
        el.id = 'selection-modal';
        el.classList.add('modal');
        el.classList.add('selection-modal');
        el.innerHTML = `
        <div class="modal-shell">
            <div class="modal-content"></div>
        </div>`;
        return el;
    },

    showSelectionModal(selection, options, onClose, mode) {
        const modal = new SelectionModal(selection, options, onClose, mode);
        modal.open();
    },

};

class SelectionModal {
    constructor(initialSelection, knownOptions, onClose, mode) {
        this._selection = initialSelection?.slice() ?? [];
        this._knownOptions = knownOptions ?? [];
        this._onClose = onClose;
        this._mode = mode;
    }

    _selection;
    _knownOptions;
    _onClose;
    _mode;
    _searchText = '';

    open() {
        const position = 'top';
        const modal = document.getElementById('selection-modal');
        const modalShell = modal.querySelector('.modal-shell');
        const modalContent = modal.querySelector('.modal-content');

        modalContent.style.cssText = 'display:flex;flex-direction:column;';

        const searchEl = document.createElement('input');
        searchEl.type = 'search';
        searchEl.style.marginBottom = '20px';
        searchEl.placeholder = 'Search...';
        searchEl.addEventListener('input', (event) => {
            this._searchText = event.target.value;
            this._updateOptionsList();
        });
        modalContent.appendChild(searchEl);

        modalContent.appendChild(this._buildOptionsList());

        const actionsContainer = document.createElement('div');
        actionsContainer.style.cssText = 'display:flex;align-items:center;margin-top:20px;';
        modalContent.appendChild(actionsContainer);

        actionsContainer.appendChild(this._buildApplyButton());
        actionsContainer.appendChild(document.createTextNode(' '));

        const closeBtn = document.createElement('button');
        closeBtn.style.marginLeft = '5px';
        closeBtn.innerHTML = 'Cancel';
        closeBtn.addEventListener('click', (event) => {
            this._close(false);
        });
        actionsContainer.appendChild(closeBtn);

        if (this._mode === 'store') {
            const removeAllBtn = document.createElement('button');
            removeAllBtn.style.marginLeft = 'auto';
            removeAllBtn.innerHTML = 'Remove All';
            removeAllBtn.addEventListener('click', (event) => {
                const selection = Array.from(document.querySelectorAll('#selection-modal input[type="checkbox"]')).map(node => node.value);
                for (const item of selection) {
                    this._handleSelectionChange(item, true);
                }
                this._close(true);
            });
            actionsContainer.appendChild(removeAllBtn);
        }

        modal.classList.add('show');
        modalShell.classList.remove('top', 'bottom', 'show');
        modalShell.classList.add(position);
        requestAnimationFrame(() => {
            modalShell.classList.add('show');
        });
    }

    _getOptions() {
        let options = this._knownOptions;

        // Add in custom items:
        const selection = this._getSelection();
        for (const item of selection) {
            if (!options.includes(item)) {
                options.push(item);
            }
        }

        options = window.AppUtils.sortItems(options);
        return options;
    }

    _getSelection() {
        let selection = this._selection;
        selection = window.AppUtils.sortItems(selection);
        return selection;
    }

    _buildOptionsList() {
        const options = this._getOptions();
        const selection = this._getSelection();
        const searchTextLC = this._searchText.toLowerCase();
        let foundExactMatch = false;

        const optionsList = document.createElement('div');
        optionsList.id = 'selectionModalOptions';
        optionsList.style.cssText = 'flex:1 1 auto;overflow:auto;';
        for (const opt of options) {
            if (searchTextLC.length && !opt.toLowerCase().includes(searchTextLC)) {
                continue;
            }
            else if (searchTextLC.length) {
                foundExactMatch = foundExactMatch || searchTextLC.trim() === opt.toLowerCase();
            }

            const optEl = document.createElement('label');
            optEl.className = 'select-option';
            optionsList.appendChild(optEl);

            const checkboxEl = document.createElement('input');
            checkboxEl.type = 'checkbox';
            checkboxEl.value = opt;
            checkboxEl.checked = selection.includes(opt);
            checkboxEl.addEventListener('input', (event) => {
                this._handleSelectionChange(opt, event.target.checked);
                this._updateApplyButton();
            });
            optEl.appendChild(checkboxEl);

            const checkmarkEl = document.createElement('span');
            checkmarkEl.classList.add('select-option-checkmark');
            optEl.appendChild(checkmarkEl);

            const contentEl = document.createElement('span');
            contentEl.classList.add('select-option-content');
            contentEl.textContent = opt;
            optEl.appendChild(contentEl);
        }

        if (this._mode === 'user' && searchTextLC.length && !foundExactMatch) {
            const addOptEl = document.createElement('a');
            addOptEl.href = '#';
            addOptEl.style.cssText = 'display:block;margin:10px 0 0;padding:4px 0;text-decoration:none;';
            addOptEl.innerHTML = `+ Add Item: <span style="color:var(--app-text-color);">"${this._searchText.trim()}"</span>`;
            addOptEl.addEventListener('click', (event) => {
                event.preventDefault();
                this._handleSelectionChange(this._searchText.trim(), true);
                this._updateOptionsList();
                this._updateApplyButton();
            });
            optionsList.appendChild(addOptEl);
        }

        return optionsList;
    }

    _updateOptionsList() {
        document.getElementById('selectionModalOptions').replaceWith(this._buildOptionsList());
    }

    _buildApplyButton() {
        const selection = this._getSelection();

        const applyBtn = document.createElement('button');
        applyBtn.id = 'selectionModalApply';
        applyBtn.innerHTML = `${this._mode === 'store' ? 'Remove' : 'Apply'} (${selection.length} Selected)`;
        applyBtn.addEventListener('click', (event) => {
            this._close(true);
        });
        return applyBtn;
    }

    _updateApplyButton() {
        document.getElementById('selectionModalApply').replaceWith(this._buildApplyButton());
    }

    _handleSelectionChange(item, selecting) {
        this._selection = this._selection.filter(i => i !== item);
        if (selecting) {
            this._selection.push(item);
        }
    }

    _close(apply) {
        const modal = document.getElementById('selection-modal');
        const modalShell = modal.querySelector('.modal-shell');
        const modalContent = modal.querySelector('.modal-content');

        modalShell.classList.remove('show');
        modalShell.addEventListener('transitionend', () => {
            modal.classList.remove('show');
            modalContent.innerHTML = '';

            this._onClose(apply ? this._selection : undefined);
        }, { once: true });
    }
}
</script>
    <script>
window.HomeView = {
    render() {
        const code = localStorage.getItem('user');

        return `
            <section id="home-view" class="home-view">
                <h1>Family Pantry</h1>
                <form id="joinForm">
                    <input type="text" id="joinCode" placeholder="User Code" value="${code || ''}" required />
                    <button type="submit" class="primary">Join</button>
                </form>
            </section>
        `;
    },
    onMount() {
        const form = document.getElementById('joinForm');
        form.addEventListener('submit', (event) => {
            event.preventDefault();
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            if (!code) {
                alert(`User for code "${code ?? ''}" not found`);
                return;
            }

            localStorage.setItem('user', code);
            Router.navigateTo('user');
        });
    },
};

</script>
    <script>
window.UserView = {
    render() {
        const code = localStorage.getItem('user');
        if (!code) {
            Router.navigateTo('home');
            return;
        }

        this.view = new UserViewImplementation(code, 'user-view');

        return `
            <section id="user-view" class="user-view"></section>
        `;
    },
    onMount() {
        this.view.init()
            .then(() => {
                this.view.render();
            });
    },
    onDestroy() {
        this.view?.destroy();
        this.view = null;
    },
    view: null,
};

class UserViewImplementation {
    constructor(code, containerId) {
        if (!code) throw new Error('No user code provided');
        if (!containerId) throw new Error('No container element provided');
        this._code = code;
        this._containerId = containerId;
        this._activeTab = window.AppUtils.getLastActiveTab(this._code);
    }

    _code;
    _containerId;
    _activeTab;
    _state;

    destroy() {
        document.body.removeAttribute('data-error');
        document.body.removeAttribute('data-loading');
    }

    async init() {
        this._state = await this._loadState();
    }

    async _loadState() {
        document.body.setAttribute('data-loading', '');
        document.body.removeAttribute('data-error');

        try {
            return await window.AppData.getUserData(this._code);
        }
        catch {
            document.body.setAttribute('data-error', 'load-user-data');
        }
        finally {
            document.body.removeAttribute('data-loading');
        }
    }

    async _saveState() {
        document.body.setAttribute('data-loading', '');

        try {
            await window.AppData.updateUserData(this._code, this._state);
        }
        catch {
            // TODO
        }
        finally {
            document.body.removeAttribute('data-loading');
        }
    }

    render() {
        const containerEl = document.getElementById(this._containerId);
        containerEl.innerHTML = ''; // clear

        containerEl.appendChild(window.AppUtils.buildTitleBarElement(this._code, 'user'));

        const viewContentEl = document.createElement('div');
        viewContentEl.classList.add('view-content');
        containerEl.appendChild(viewContentEl);

        if (this._activeTab === 'supplies') {
            viewContentEl.appendChild(this._buildSuppliesViewContent());
        }
        else if (this._activeTab === 'meals') {
            viewContentEl.appendChild(this._buildMealsViewContent());
        }

        containerEl.appendChild(window.AppUtils.buildBottomMenuElement(this._code, this._activeTab, (newTab) => {
            this._activeTab = newTab;
            this.render();
        }));

        containerEl.appendChild(window.AppUtils.buildSelectionModalElement());
    }

    _buildCardHtml(title, propName) {
        const buildListHtml = (items) => {
            if (!items?.length) return '<span style="font-style:italic;">None</span>';
            return window.AppUtils.sortItems(items).join(', ');
        };
        return `
        <div class="wants-card">
            <div class="wants-card__body">
                <div class="wants-card__title">${title}</div>
                <div class="wants-card__list">${buildListHtml(this._state[propName])}</div>
            </div>
            <div class="wants-card__actions">
                <button data-edit-action="${propName}">Edit</button>
            </div>
        </div>`;
    }

    _buildMealsViewContent() {
        const el = document.createElement('div');
        el.innerHTML = `
            <div class="wants-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="18px" width="18px"><path d="M440-240q-117 0-198.5-81.5T160-520v-240q0-33 23.5-56.5T240-840h500q58 0 99 41t41 99q0 58-41 99t-99 41h-20v40q0 117-81.5 198.5T440-240ZM240-640h400v-120H240v120Zm200 320q83 0 141.5-58.5T640-520v-40H240v40q0 83 58.5 141.5T440-320Zm280-320h20q25 0 42.5-17.5T800-700q0-25-17.5-42.5T740-760h-20v120ZM160-120v-80h640v80H160Zm280-440Z"/></svg>
                Breakfast
            </div>
            ${this._buildCardHtml('Wants', 'breakfastWants')}
            ${this._buildCardHtml('Maybes', 'breakfastMaybes')}
            ${this._buildCardHtml('Not Wants', 'breakfastNotWants')}
            <div class="wants-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="18px" width="18px"><path d="M160-120q-33 0-56.5-23.5T80-200v-440q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v440q0 33-23.5 56.5T800-120H160Zm0-80h160v-120q-26-6-43-27.5T260-397v-163h40v151h30v-151h40v151h30v-151h40v163q0 28-17 49.5T380-320v120h200v-88q-26-15-43-50.5T520-420q0-58 26-99t64-41q37 0 63.5 41t26.5 99q0 47-17 82.5T640-288v88h160v-440H160v440Zm240-520h160v-80H400v80ZM160-200v-440 440Z"/></svg>
                Lunch
            </div>
            ${this._buildCardHtml('Wants', 'lunchWants')}
            ${this._buildCardHtml('Maybes', 'lunchMaybes')}
            ${this._buildCardHtml('Not Wants', 'lunchNotWants')}
            <div class="wants-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="18px" width="18px"><path d="M322-400q-100 0-171-70T80-640q0-100 71-170t172-70h16q-22 25-34 56t-12 64q0 75 52.5 127.5T473-580q23 0 45-5.5t42-16.5q-14 88-81 145t-157 57Zm-1-80q24 0 47.5-6.5T412-507q-87-21-142-90.5T213-756q-26 23-39.5 53T160-640q0 66 47 113t114 47Zm399-40h80v-120h-80v120Zm40 160q17 0 28.5-11.5T800-400v-40h-80v40q0 17 11.5 28.5T760-360ZM234-160h172q14 0 25-8t14-22l13-50H182l13 50q3 14 14 22t25 8Zm86 0ZM40-80v-80h80q-1-3-1.5-5.5T117-171L80-320h480l-37 149q-1 3-1.5 5.5T520-160h200v-127q-36-13-58-44t-22-69v-320h240v320q0 38-22 69t-58 44v127h120v80H40Zm246-538Zm474 178Z"/></svg>
                Dinner
            </div>
            ${this._buildCardHtml('Wants', 'dinnerWants')}
            ${this._buildCardHtml('Maybes', 'dinnerMaybes')}
            ${this._buildCardHtml('Not Wants', 'dinnerNotWants')}
        `;
        el.addEventListener('click', (event) => {
            const action = event.target.getAttribute('data-edit-action');
            if (!action) return;

            this._showSelectionModal(action);
        });
        return el;
    }

    _buildSuppliesViewContent() {
        const el = document.createElement('div');
        el.innerHTML = `
            <div class="wants-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="18px" width="18px"><path d="M221-120q-27 0-48-16.5T144-179L42-549q-5-19 6.5-35T80-600h190l176-262q5-8 14-13t19-5q10 0 19 5t14 13l176 262h192q20 0 31.5 16t6.5 35L816-179q-8 26-29 42.5T739-120H221Zm-1-80h520l88-320H132l88 320Zm260-80q33 0 56.5-23.5T560-360q0-33-23.5-56.5T480-440q-33 0-56.5 23.5T400-360q0 33 23.5 56.5T480-280ZM367-600h225L479-768 367-600Zm113 240Z"/></svg>
                Groceries
            </div>
            ${this._buildCardHtml('Wants', 'groceryWants')}
            <div class="wants-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="18px" width="18px"><path d="M160-280v-480H80v-80h160v480h600v80H160Zm80 200q-33 0-56.5-23.5T160-160q0-33 23.5-56.5T240-240q33 0 56.5 23.5T320-160q0 33-23.5 56.5T240-80Zm40-320v-240h240v240H280Zm80-80h80v-80h-80v80Zm200 80v-240h240v240H560Zm80-80h80v-80h-80v80ZM760-80q-33 0-56.5-23.5T680-160q0-33 23.5-56.5T760-240q33 0 56.5 23.5T840-160q0 33-23.5 56.5T760-80ZM360-480h80-80Zm280 0h80-80Z"/></svg>
                Other
            </div>
            ${this._buildCardHtml('Wants', 'otherWants')}
        `;
        el.addEventListener('click', (event) => {
            const action = event.target.getAttribute('data-edit-action');
            if (!action) return;

            this._showSelectionModal(action);
        });
        return el;
    }

    _showSelectionModal(context) {
        let selection = [];
        let listPropName = '';
        let otherListPropNames = [];
        if (context === 'groceryWants') {
            listPropName = 'groceryWants';
        }
        else if (context === 'otherWants') {
            listPropName = 'otherWants';
        }
        else if (context === 'dinnerWants') {
            listPropName = 'dinnerWants';
            otherListPropNames = ['dinnerMaybes', 'dinnerNotWants'];
        }
        else if (context === 'dinnerMaybes') {
            listPropName = 'dinnerMaybes';
            otherListPropNames = ['dinnerWants', 'dinnerNotWants'];
        }
        else if (context === 'dinnerNotWants') {
            listPropName = 'dinnerNotWants';
            otherListPropNames = ['dinnerWants', 'dinnerMaybes'];
        }
        else if (context === 'breakfastWants') {
            listPropName = 'breakfastWants';
            otherListPropNames = ['breakfastMaybes', 'breakfastNotWants'];
        }
        else if (context === 'breakfastMaybes') {
            listPropName = 'breakfastMaybes';
            otherListPropNames = ['breakfastWants', 'breakfastNotWants'];
        }
        else if (context === 'breakfastNotWants') {
            listPropName = 'breakfastNotWants';
            otherListPropNames = ['breakfastWants', 'breakfastMaybes'];
        }
        else if (context === 'lunchWants') {
            listPropName = 'lunchWants';
            otherListPropNames = ['lunchMaybes', 'lunchNotWants'];
        }
        else if (context === 'lunchMaybes') {
            listPropName = 'lunchMaybes';
            otherListPropNames = ['lunchWants', 'lunchNotWants'];
        }
        else if (context === 'lunchNotWants') {
            listPropName = 'lunchNotWants';
            otherListPropNames = ['lunchWants', 'lunchMaybes'];
        }
        selection = this._state[listPropName];

        let options = [];
        if (context.startsWith('grocery')) {
            options = window.AppData.getKnownGroceryOptions();
        }
        else if (context.startsWith('other')) {
            options = window.AppData.getKnownOtherOptions();
        }
        else if (context.startsWith('dinner')) {
            options = window.AppData.getKnownDinnerOptions();
        }
        else if (context.startsWith('lunch')) {
            options = window.AppData.getKnownLunchOptions();
        }
        else if (context.startsWith('breakfast')) {
            options = window.AppData.getKnownBreakfastOptions();
        }

        window.AppUtils.showSelectionModal(selection, options, async (newSelection) => {
            if (newSelection) {
                this._state[listPropName] = newSelection;

                otherListPropNames.forEach((propName) => {
                    this._state[propName] = this._state[propName].filter(i => !newSelection.includes(i));
                });

                await this._saveState();
                this.render();
            }
        }, 'user');
    }
}
</script>
    <script>
window.StoreView = {
    render() {
        const code = localStorage.getItem('user');
        if (!code) {
            Router.navigateTo('home');
            return;
        }

        this.view = new StoreViewImplementation(code, 'store-view');

        return `
            <section id="store-view" class="store-view"></section>
        `;
    },
    onMount() {
        this.view.init()
            .then(() => {
                this.view.render();
            });
    },
    onDestroy() {
        this.view?.destroy();
        this.view = null;
    },
    view: null,
};

class StoreViewImplementation {
    constructor(code, containerId) {
        if (!code) throw new Error('No user code provided');
        if (!containerId) throw new Error('No container element provided');
        this._code = code;
        this._containerId = containerId;
        this._activeTab = window.AppUtils.getLastActiveTab(this._code);
    }

    _code;
    _containerId;
    _activeTab;
    _state;

    destroy() {
        document.body.removeAttribute('data-error');
        document.body.removeAttribute('data-loading');
    }

    async init() {
        this._state = await this._loadState();
    }

    async _loadState() {
        document.body.setAttribute('data-loading', '');
        document.body.removeAttribute('data-error');

        const codes = window.AppData.getAllUserCodes();

        const state = {};
        for (const code of codes) {
            try {
                const userState = await window.AppData.getUserData(code);
                state[code] = userState;
            }
            catch {
                document.body.setAttribute('data-error', 'load-user-data');
            }
        }

        document.body.removeAttribute('data-loading');

        return state;
    }

    async _saveState() {
        document.body.setAttribute('data-loading', '');

        const codes = window.AppData.getAllUserCodes();
        for (const code of codes) {
            try {
                await window.AppData.updateUserData(code, this._state[code]);
            }
            catch {
                // TODO
            }
        }

        document.body.removeAttribute('data-loading');
    }

    render() {
        const containerEl = document.getElementById(this._containerId);
        containerEl.innerHTML = ''; // clear

        containerEl.appendChild(window.AppUtils.buildTitleBarElement(this._code, 'store'));

        const viewContentEl = document.createElement('div');
        viewContentEl.classList.add('view-content');
        containerEl.appendChild(viewContentEl);

        if (this._activeTab === 'supplies') {
            viewContentEl.appendChild(this._buildSuppliesViewContent());
        }
        else if (this._activeTab === 'meals') {
            viewContentEl.appendChild(this._buildMealsViewContent());
        }

        containerEl.appendChild(window.AppUtils.buildBottomMenuElement(this._code, this._activeTab, (newTab) => {
            this._activeTab = newTab;
            this.render();
        }));

        containerEl.appendChild(window.AppUtils.buildSelectionModalElement());
    }

    _buildCardsHtml(titleHtml, propNames) {
        let html = '';
        for (const propName of propNames) {
            html += this._buildCardHtml(propName);
        }

        return `
            ${titleHtml}
            ${html.length ? html : `
                <div class="wants-card">
                    <div class="wants-card__body">
                        <div class="wants-card__list"><i>None</i></div>
                    </div>
                </div>
            `}
        `;
    }

    _buildCardHtml(propName) {
        const itemsByUser = [];
        for (const code in this._state) {
            const userState = this._state[code];
            itemsByUser.push({ code: code, items: userState[propName] });
        }

        const buildListsHtml = (items) => {
            let html = '';
            for (const obj of items) {
                if (!obj.items?.length) continue;
                html += `
                <div class="wants-card__list">
                    <span class="wants-user">${obj.code === this._code ? 'Me' : obj.code.substring(0, 2)}</span>:
                    ${window.AppUtils.sortItems(obj.items).join(', ')}
                </div>`;
            }
            return html;
        };

        const listsHtml = buildListsHtml(itemsByUser);
        if (!listsHtml) return '';

        const getTitleFromPropName = (name) => {
            if (name.endsWith('NotWants')) return 'Not Wants';
            if (name.endsWith('Wants')) return 'Wants';
            if (name.endsWith('Maybes')) return 'Maybes';
            return name;
        };

        return `
        <div class="wants-card">
            <div class="wants-card__body">
                <div class="wants-card__title">${getTitleFromPropName(propName)}</div>
                ${buildListsHtml(itemsByUser)}
            </div>
        </div>`;
    }

    _buildMealsViewContent() {
        const el = document.createElement('div');
        el.innerHTML = `
            ${this._buildCardsHtml(`
                <div class="wants-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="18px" width="18px"><path d="M440-240q-117 0-198.5-81.5T160-520v-240q0-33 23.5-56.5T240-840h500q58 0 99 41t41 99q0 58-41 99t-99 41h-20v40q0 117-81.5 198.5T440-240ZM240-640h400v-120H240v120Zm200 320q83 0 141.5-58.5T640-520v-40H240v40q0 83 58.5 141.5T440-320Zm280-320h20q25 0 42.5-17.5T800-700q0-25-17.5-42.5T740-760h-20v120ZM160-120v-80h640v80H160Zm280-440Z"/></svg>
                    Breakfast
                    <button style="margin-left:auto;" data-edit-action="breakfastWants,breakfastMaybes,breakfastNotWants">Edit</button>
                </div>`,
            ['breakfastWants', 'breakfastMaybes', 'breakfastNotWants']
        )}
            ${this._buildCardsHtml(`
                <div class="wants-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="18px" width="18px"><path d="M160-120q-33 0-56.5-23.5T80-200v-440q0-33 23.5-56.5T160-720h160v-80q0-33 23.5-56.5T400-880h160q33 0 56.5 23.5T640-800v80h160q33 0 56.5 23.5T880-640v440q0 33-23.5 56.5T800-120H160Zm0-80h160v-120q-26-6-43-27.5T260-397v-163h40v151h30v-151h40v151h30v-151h40v163q0 28-17 49.5T380-320v120h200v-88q-26-15-43-50.5T520-420q0-58 26-99t64-41q37 0 63.5 41t26.5 99q0 47-17 82.5T640-288v88h160v-440H160v440Zm240-520h160v-80H400v80ZM160-200v-440 440Z"/></svg>
                    Lunch
                    <button style="margin-left:auto;" data-edit-action="lunchWants,lunchMaybes,lunchNotWants">Edit</button>
                </div>`,
            ['lunchWants', 'lunchMaybes', 'lunchNotWants']
        )}
            ${this._buildCardsHtml(`
                <div class="wants-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="18px" width="18px"><path d="M322-400q-100 0-171-70T80-640q0-100 71-170t172-70h16q-22 25-34 56t-12 64q0 75 52.5 127.5T473-580q23 0 45-5.5t42-16.5q-14 88-81 145t-157 57Zm-1-80q24 0 47.5-6.5T412-507q-87-21-142-90.5T213-756q-26 23-39.5 53T160-640q0 66 47 113t114 47Zm399-40h80v-120h-80v120Zm40 160q17 0 28.5-11.5T800-400v-40h-80v40q0 17 11.5 28.5T760-360ZM234-160h172q14 0 25-8t14-22l13-50H182l13 50q3 14 14 22t25 8Zm86 0ZM40-80v-80h80q-1-3-1.5-5.5T117-171L80-320h480l-37 149q-1 3-1.5 5.5T520-160h200v-127q-36-13-58-44t-22-69v-320h240v320q0 38-22 69t-58 44v127h120v80H40Zm246-538Zm474 178Z"/></svg>
                    Dinner
                    <button style="margin-left:auto;" data-edit-action="dinnerWants,dinnerMaybes,dinnerNotWants">Edit</button>
                </div>`,
            ['dinnerWants', 'dinnerMaybes', 'dinnerNotWants']
        )}
        `;
        el.addEventListener('click', (event) => {
            const action = event.target.getAttribute('data-edit-action');
            if (!action) return;

            this._showSelectionModal(action.split(','));
        });
        return el;
    }

    _buildSuppliesViewContent() {
        const el = document.createElement('div');
        el.innerHTML = `
            ${this._buildCardsHtml(`
                <div class="wants-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="18px" width="18px"><path d="M322-400q-100 0-171-70T80-640q0-100 71-170t172-70h16q-22 25-34 56t-12 64q0 75 52.5 127.5T473-580q23 0 45-5.5t42-16.5q-14 88-81 145t-157 57Zm-1-80q24 0 47.5-6.5T412-507q-87-21-142-90.5T213-756q-26 23-39.5 53T160-640q0 66 47 113t114 47Zm399-40h80v-120h-80v120Zm40 160q17 0 28.5-11.5T800-400v-40h-80v40q0 17 11.5 28.5T760-360ZM234-160h172q14 0 25-8t14-22l13-50H182l13 50q3 14 14 22t25 8Zm86 0ZM40-80v-80h80q-1-3-1.5-5.5T117-171L80-320h480l-37 149q-1 3-1.5 5.5T520-160h200v-127q-36-13-58-44t-22-69v-320h240v320q0 38-22 69t-58 44v127h120v80H40Zm246-538Zm474 178Z"/></svg>
                    Grocery
                    <button style="margin-left:auto;" data-edit-action="groceryWants">Edit</button>
                </div>`,
            ['groceryWants']
        )}
            ${this._buildCardsHtml(`
                <div class="wants-title">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" height="18px" width="18px"><path d="M160-280v-480H80v-80h160v480h600v80H160Zm80 200q-33 0-56.5-23.5T160-160q0-33 23.5-56.5T240-240q33 0 56.5 23.5T320-160q0 33-23.5 56.5T240-80Zm40-320v-240h240v240H280Zm80-80h80v-80h-80v80Zm200 80v-240h240v240H560Zm80-80h80v-80h-80v80ZM760-80q-33 0-56.5-23.5T680-160q0-33 23.5-56.5T760-240q33 0 56.5 23.5T840-160q0 33-23.5 56.5T760-80ZM360-480h80-80Zm280 0h80-80Z"/></svg>
                    Other
                    <button style="margin-left:auto;" data-edit-action="otherWants">Edit</button>
                </div>`,
            ['otherWants']
        )}
        `;
        el.addEventListener('click', (event) => {
            const action = event.target.getAttribute('data-edit-action');
            if (!action) return;

            this._showSelectionModal(action.split(','));
        });
        return el;
    }

    _showSelectionModal(propNames) {
        let selectedItems = [];
        for (const code in this._state) {
            const userState = this._state[code];
            for (const propName of propNames) {
                selectedItems = selectedItems.concat(userState[propName]);
            }
        }

        selectedItems = [...new Set(selectedItems)]; // distinct

        window.AppUtils.showSelectionModal([], selectedItems, async (selection) => {
            if (selection) {
                for (const code in this._state) {
                    const userState = this._state[code];
                    for (const propName of propNames) {
                        userState[propName] = userState[propName].filter(i => !selection.includes(i));
                    }
                }

                await this._saveState();
                this.render();
            }
        }, 'store');
    }
}
</script>
    <script>
window.Router = (() => {
    const routes = {
        home: HomeView,
        user: UserView,
        store: StoreView,
    };

    let currentView = null;

    function render(route) {
        const app = document.getElementById('app');
        const view = routes[route] || HomeView;

        if (currentView?.onDestroy) {
            currentView.onDestroy();
        }

        app.classList.add('fade-out');
        setTimeout(() => {
            document.body.setAttribute('data-route', route);
            app.innerHTML = view.render() || '<i>Loading...</i>';
            currentView = view;

            app.classList.remove('fade-out');
            app.classList.add('fade-in');
            setTimeout(() => app.classList.remove('fade-in'), 300);

            if (view.onMount) {
                view.onMount();
            }
        }, 300);
    }

    function init() {
        window.addEventListener('popstate', (e) => {
            render(e.state?.route || 'home');
        });

        const initialRoute = location.hash.replace('#', '') || 'home';
        render(initialRoute);

        const app = document.getElementById('app');
        app.addEventListener('click', (event) => {
            const target = event.target?.getAttribute('data-navigate-to');
            if (target) {
                event.preventDefault();
                navigateTo(target);
            }
        });
    }

    function navigateTo(route) {
        window.location.hash = route;
        render(route);
    }

    return {
        init,
        navigateTo
    };
})();

</script>
    <script>
window.addEventListener("DOMContentLoaded", () => {
    Router.init();
});
</script>
</body>

</html>